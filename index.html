<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <title>DondlingerGC-Web ‚Äî Professional Websites & Online Tools</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        console.log('Loading QRCode library from CDN...');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
        onload="console.log('‚úì QRCode library loaded from CDN'); console.log('QRCode available:', !!window.QRCode);"
        onerror="console.error('‚úó Failed to load QRCode library from CDN. Falling back to local file.');"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="_site-config.js"></script>
        <script src="js/bridge-client.js"></script>
        <script>
            // Debug: Check if BridgeClient is loaded
            console.log('After bridge-client.js, window.BridgeClient =', window.BridgeClient);
        </script>
    <script src="js/file-manager.js"></script>
    <style>
        /* Error message style for JS fatal errors */
        #fatal-error {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #c00;
            color: #fff;
            font-size: 1.3em;
            padding: 24px 16px;
            z-index: 9999;
            text-align: center;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 2px 12px #0008;
            display: none;
        }

        :root {
            --bg: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            --accent: #00d4ff;
            --window-bg: rgba(255, 255, 255, 0.98);
            --border: rgba(255, 255, 255, 0.2);
            --muted: #9aa3b2;
            font-size: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: #fff;
            overflow: hidden;
        }

        /* Desktop container */
        #desktop {
            display: none;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* Desktop background */
        .desktop-bg {
            position: absolute;
            inset: 0;
            background: var(--bg);
            z-index: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Animated Clock Display */
        .clock-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 32px;
            opacity: 1;
            transition: opacity 0.5s;
        }

        .clock-display.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .time-container {
            position: relative;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .time-digit {
            font-size: 8rem;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 40px var(--accent), 0 0 80px var(--accent), 0 0 120px rgba(0, 212, 255, 0.5);
            font-family: 'Courier New', monospace;
            letter-spacing: -4px;
            position: relative;
            animation: glow-pulse 2s ease-in-out infinite;
        }

        .time-separator {
            font-size: 8rem;
            font-weight: 900;
            color: var(--accent);
            opacity: 0.6;
            animation: blink 1s step-start infinite;
        }

        .date-display {
            font-size: 2rem;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 8px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            animation: float 3s ease-in-out infinite;
        }

        .analog-ring {
            position: absolute;
            width: 400px;
            height: 400px;
            border: 3px solid var(--accent);
            border-radius: 50%;
            opacity: 0.3;
            animation: rotate-ring 20s linear infinite;
            box-shadow: 0 0 40px var(--accent), inset 0 0 40px var(--accent);
        }

        .analog-ring:nth-child(2) {
            width: 450px;
            height: 450px;
            animation-duration: 30s;
            animation-direction: reverse;
        }

        .clock-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent);
            animation: float-particle 10s ease-in-out infinite;
        }

        @keyframes glow-pulse {

            0%,
            100% {
                text-shadow: 0 0 40px var(--accent), 0 0 80px var(--accent), 0 0 120px rgba(0, 212, 255, 0.5);
            }

            50% {
                text-shadow: 0 0 60px var(--accent), 0 0 120px var(--accent), 0 0 180px rgba(0, 212, 255, 0.8);
            }
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 0.6;
            }

            51%,
            100% {
                opacity: 0.1;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes rotate-ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes float-particle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* Scrolling Branded Messages */
        .branded-scrollers {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .scroller {
            position: absolute;
            white-space: nowrap;
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(0, 212, 255, 0.12);
            text-transform: uppercase;
            letter-spacing: 8px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
            animation: scroll-diagonal 30s linear infinite;
        }

        .scroller:nth-child(2) {
            animation-delay: -10s;
            animation-duration: 35s;
            font-size: 2.2rem;
            color: rgba(0, 212, 255, 0.1);
        }

        .scroller:nth-child(3) {
            animation-delay: -20s;
            animation-duration: 40s;
            font-size: 2.8rem;
            color: rgba(0, 212, 255, 0.09);
        }

        @keyframes scroll-diagonal {
            0% {
                transform: translate(-100%, 100vh) rotate(-15deg);
            }

            100% {
                transform: translate(120vw, -100%) rotate(-15deg);
            }
        }

        /* Window styles */
        .window {
            position: absolute;
            background: var(--window-bg);
            border: 2px solid var(--accent);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.3), 0 0 0 1px rgba(0, 212, 255, 0.1);
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: box-shadow 0.2s;
        }

        .window.active {
            display: flex;
        }

        .window.minimized {
            display: none !important;
        }

        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: calc(100% - 60px) !important;
            border-radius: 0;
        }

        .window.split-left {
            top: 0 !important;
            left: 0 !important;
            width: 50% !important;
            height: calc(100% - 60px) !important;
            border-radius: 0;
        }

        .window.split-right {
            top: 0 !important;
            left: 50% !important;
            width: 50% !important;
            height: calc(100% - 60px) !important;
            border-radius: 0;
        }

        .window-header {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #000;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            font-weight: 700;
            font-size: 1em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        .window-controls {
            display: flex;
            gap: 8px;
        }

        .window-control {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
            border: 2px solid rgba(0, 0, 0, 0.3);
        }

        .window-control:hover {
            transform: scale(1.15);
        }

        .window-control:nth-child(1) {
            background: #ff5f56;
        }

        .window-control:nth-child(2) {
            background: #ffbd2e;
        }

        .window-control:nth-child(3) {
            background: #27c93f;
        }

        .window-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #fff;
            color: #000;
        }

        .window-content h1 {
            font-size: 2.5rem;
            margin-bottom: 16px;
            color: var(--accent);
        }

        .window-content h2 {
            font-size: 1.8rem;
            margin-bottom: 12px;
            margin-top: 24px;
            color: var(--accent);
        }

        .window-content p {
            line-height: 1.7;
            margin-bottom: 16px;
            font-size: 1.05rem;
        }

        .window-content strong {
            color: var(--accent);
        }

        /* Blueprints window specific styles */
        .blueprints-list {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            margin-bottom: 32px;
        }

        .blueprint-thumb {
            width: 180px;
            cursor: pointer;
            border: 2px solid var(--accent);
            border-radius: 10px;
            background: #f7f7fa;
            box-shadow: 0 2px 12px rgba(0, 212, 255, 0.2);
            overflow: hidden;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .blueprint-thumb:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }

        .blueprint-preview {
            margin-top: 32px;
            padding: 24px;
            background: #f7f7fa;
            border-radius: 10px;
            border: 2px solid var(--accent);
        }

        .blueprint-preview img,
        .blueprint-preview embed {
            max-width: 100%;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 12px rgba(0, 212, 255, 0.2);
        }

        .blueprint-preview embed {
            width: 100%;
            min-height: 500px;
        }

        /* Taskbar */
        .taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(10, 15, 25, 0.95), rgba(5, 10, 20, 0.98));
            backdrop-filter: blur(12px);
            border-top: 2px solid var(--accent);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 212, 255, 0.2);
        }

        .start-button {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
        }

        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.5);
        }

        .taskbar-apps {
            display: flex;
            gap: 6px;
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .taskbar-app {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            border: 1px solid transparent;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .taskbar-app:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
        }

        .taskbar-app.active {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .taskbar-app.minimized {
            opacity: 0.6;
        }

        .clock {
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Start menu */
        .start-menu {
            position: absolute;
            bottom: 70px;
            left: 16px;
            width: 300px;
            background: rgba(10, 15, 25, 0.98);
            backdrop-filter: blur(12px);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            display: none;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.3);
            z-index: 1001;
            max-height: 60vh;
            overflow-y: auto;
        }

        .start-menu.show {
            display: flex;
        }

        .tooltip-toggle {
            padding: 10px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.9rem;
        }

        .tooltip-toggle:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .tooltip-toggle.active {
            background: var(--accent);
            color: #000;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 300px;
            z-index: 10000;
            pointer-events: none;
            border: 1px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip.show {
            opacity: 1;
        }

        .start-menu-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
            font-weight: 600;
            border: 1px solid transparent;
        }

        .start-menu-item:hover {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        /* Context menu */
        .context-menu {
            position: absolute;
            background: rgba(10, 15, 25, 0.98);
            backdrop-filter: blur(12px);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.3);
            z-index: 2000;
        }

        .context-menu.show {
            display: flex;
        }

        .context-menu-item {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
            font-size: 0.9rem;
        }

        .context-menu-item:hover {
            background: var(--accent);
            color: #000;
        }

        /* Mobile fallback */
        .page-content {
            padding: 40px 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .page-content h1 {
            font-size: 2.5rem;
            margin-bottom: 16px;
        }

        .page-content p {
            line-height: 1.7;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            #desktop {
                display: none !important;
            }

            .page-content {
                display: block !important;
            }
        }
        
        /* Ensure Desktop is visible on non-mobile if JS fails */
        @media (min-width: 769px) {
            #desktop {
                display: block;
            }
            .page-content {
                display: none; 
            }
        }

        /* QR Code Display */
        .qr-container {
            position: fixed; /* Changed from absolute to fixed */
            top: 20%;
            right: 20px;
            background: rgba(0, 0, 0, 0.95); /* Darker background */
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 24px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 10000; /* Higher z-index */
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            max-width: 90vw; /* Responsive max width */
            width: auto;
        }

        .qr-container.show {
            display: flex;
        }

        .qr-title {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            margin: 0;
        }

        .qr-code {
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .qr-instructions {
            color: #ccc;
            font-size: 0.8rem;
            text-align: center;
            line-height: 1.4;
            margin: 0;
        }

        .qr-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 999;
            visibility: visible !important;
        }

        .qr-toggle:hover {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
    </style>
</head>

<body>

    <div id="fatal-error"></div>

    <!-- Temporary Cotton Thimble Widget (90 days) -->
    <div id="cottonthimble-widget"
        style="position:fixed;top:32px;right:32px;z-index:20000;background:rgba(255,255,255,0.97);border:2px solid #00d4ff;border-radius:16px;box-shadow:0 4px 24px #00d4ff44;padding:20px 28px;display:none;align-items:center;gap:18px;cursor:pointer;transition:box-shadow 0.2s;">
        <span style="font-size:2.2rem;">üßµ</span>
        <div style="display:flex;flex-direction:column;">
            <span style="font-weight:700;font-size:1.1rem;color:#00d4ff;">Cotton Thimble</span>
            <span style="font-size:0.95rem;color:#333;">Virtual Store Tour</span>
        </div>
        <button
            style="margin-left:18px;padding:8px 16px;background:#00d4ff;color:#000;font-weight:700;border:none;border-radius:8px;cursor:pointer;font-size:1rem;box-shadow:0 2px 8px #00d4ff33;">Open</button>
    </div>

    <script>
        // Remove widget after 90 days (timestamp check)
        (function () {
            const widget = document.getElementById('cottonthimble-widget');
            const created = 1769721600000; // Jan 29, 2026 UTC ms
            const now = Date.now();
            const ninetyDays = 1000 * 60 * 60 * 24 * 90;
            if (now - created > ninetyDays) {
                widget && widget.remove();
            } else if (widget) {
                widget.onclick = function (e) {
                    e.preventDefault();
                    if (window.System) window.System.openWindow('cottonthimble');
                };
            }
        })();
    </script>

    <!-- Desktop UI -->
    <div id="desktop">
        <div class="desktop-bg">
            <div class="analog-ring"></div>
            <div class="analog-ring"></div>
            <div style="position:absolute;top:60px;left:50%;transform:translateX(-50%);text-align:center;z-index:5;">
                <h1
                    style="font-size:3rem;font-weight:900;color:#fff;margin:0 0 8px 0;text-shadow:0 2px 20px rgba(0,0,0,0.8);letter-spacing:2px;">
                    DONDLINGER GENERAL CONTRACTING</h1>
                <p
                    style="font-size:1.3rem;color:var(--accent);margin:0;text-shadow:0 2px 10px rgba(0,0,0,0.8);font-weight:600;letter-spacing:1px;">
                    Design ‚Ä¢ Build ‚Ä¢ Digital</p>
            </div>
            <div class="clock-display" id="clock-display">
                <div class="time-container">
                    <span class="time-digit" id="hours">00</span>
                    <span class="time-separator">:</span>
                    <span class="time-digit" id="minutes">00</span>
                    <span class="time-separator">:</span>
                    <span class="time-digit" id="seconds">00</span>
                </div>
                <div class="date-display" id="date-display">Loading...</div>
            </div>
            <div class="clock-particles" id="clock-particles"></div>
        </div>

        <!-- QR Code Toggle Button -->
        <button class="qr-toggle" id="qr-toggle" onclick="toggleQRCode()">üì± Mobile</button>

        <!-- QR Code Display -->
        <div class="qr-container" id="qr-container">
            <h3 class="qr-title" id="qr-title">Mobile File Transfer</h3>
            <div class="qr-code" id="qr-code"></div>
            <p class="qr-instructions" id="qr-instructions">Scan to connect P2P</p>
            
            <div id="qr-answer-section" style="display:none; width: 100%; max-width: 300px; text-align: center; margin-top: 12px; border-top: 1px solid #444; padding-top: 12px;">
                <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 8px;">Step 2: Scan the Answer from your phone</p>
                
                <div id="reader-container" style="display:none; margin-bottom: 10px;">
                    <div id="qr-reader" style="width: 100%; height: 250px; background: #000;"></div>
                    <button onclick="window.System.stopScanner()" style="margin-top: 5px; padding: 4px 12px; background: #cc0000; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Stop Camera</button>
                </div>

                <div id="manual-input-container">
                    <button onclick="window.System.startScanner()" style="margin-bottom: 8px; padding: 8px 16px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; gap: 8px;">
                        <span>üì∑</span> Scan QR Answer
                    </button>
                    
                    <details style="text-align: left; font-size: 0.75rem; color: #666; margin-top: 8px; cursor: pointer;">
                        <summary>Or paste code manually</summary>
                        <textarea id="qr-answer-input" placeholder='Paste Answer JSON here...' style="width: 100%; height: 50px; background: #111; color: #fff; border: 1px solid #444; border-radius: 4px; font-family: monospace; font-size: 0.7rem; resize: none; margin-top: 5px;"></textarea>
                        <button onclick="window.System.handleManualAnswer()" style="margin-top: 5px; padding: 6px 16px; background: var(--accent); color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%;">Connect</button>
                    </details>
                </div>
            </div>
        </div>

        <div id="windows-container"></div>

        <!-- Taskbar -->
        <div class="taskbar">
            <button class="start-button" onclick="toggleStartMenu()">START</button>
            <div class="taskbar-apps" id="taskbar-apps"></div>
            <div class="clock" id="clock">00:00</div>
        </div>

        <!-- Start Menu -->
        <div class="start-menu" id="start-menu">
            <div class="tooltip-toggle" id="tooltip-toggle" onclick="toggleTooltips()">üí° Tooltips: OFF</div>
            <div id="start-menu-items"></div>
        </div>

        <!-- Tooltip Container -->
        <div class="tooltip" id="tooltip"></div>

        <!-- Context Menu -->
        <div class="context-menu" id="context-menu">
            <div class="context-menu-item" onclick="restoreWindow(activeWindow?.id.replace('-window',''))">Restore</div>
            <div class="context-menu-item" onclick="maximizeWindow(activeWindow?.id.replace('-window',''))">Maximize
            </div>
            <div class="context-menu-item" onclick="splitWindowLeft(activeWindow?.id.replace('-window',''))">Split Left
            </div>
            <div class="context-menu-item" onclick="splitWindowRight(activeWindow?.id.replace('-window',''))">Split
                Right</div>
            <div class="context-menu-item" onclick="minimizeWindow(activeWindow?.id.replace('-window',''))">Minimize
            </div>
            <div class="context-menu-item" onclick="closeWindow(activeWindow?.id.replace('-window',''))">Close</div>
        </div>
    </div>

    <!-- Mobile Fallback -->
    <div class="page-content">
        <h1>DondlingerGC Desktop</h1>
        <p><strong>Professional Digital Solutions Platform</strong></p>
        <p>Access tools, blueprints, and interactive web design features.</p>
        <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 8px;">
            <p style="margin-bottom: 10px;">If the desktop doesn't load automatically:</p>
            <button onclick="document.getElementById('desktop').style.display='block'; document.querySelector('.page-content').style.display='none'; if(window.System) { window.System.renderDesktop(); window.System.applySavedSettings(); }" style="padding: 10px 20px; background: var(--accent); color: black; font-weight: bold; border: none; border-radius: 6px; cursor: pointer;">
                üñ•Ô∏è Force Desktop Mode
            </button>
        </div>
    </div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
           console.error('Global Error:', msg, url, line, col, error);
           // Only show major syntax/runtime errors visible to user if totally broken
           if (document.getElementById('desktop').style.display !== 'block') {
               const errDiv = document.createElement('div');
               errDiv.style.cssText = 'position:fixed;top:10px;left:10px;background:#300;color:#f88;padding:10px;z-index:99999;border:1px solid red;max-width:90%;word-wrap:break-word;';
               errDiv.innerText = 'JS Error: ' + msg + ' (Line ' + line + ')';
               document.body.appendChild(errDiv);
           }
        };

        'use strict';
        /* global BridgeClient, QRCode, VirtualSystem, Html5Qrcode */

        /**
         * üñ•Ô∏è Virtual Desktop Kernel (System)
         * Manages process lifecycle, state synchronization, and remote communication.
         */
        class VirtualSystem {
            // Force desktop display
            forceDesktop() {
                try {
                document.getElementById('desktop').style.display = 'block';
                const pageContent = document.querySelector('.page-content');
                if (pageContent) pageContent.style.display = 'none';
                this.renderDesktop();
                } catch(e) { alert('Desktop Load Failed: '+e.message); }
            }

            // Open window from hash if present
            openWindowFromHash() {
                const hash = window.location.hash.replace('#', '');
                if (!hash) return;
                const page = this.pages.find(p => p.id === hash);
                if (page) {
                    this.openWindow(hash);
                }
            }
            // Animated clock particles
            animateClockParticles() {
                const container = document.getElementById('clock-particles');
                if (!container) return;
                container.innerHTML = '';
                const numParticles = 24;
                for (let i = 0; i < numParticles; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    const angle = (i / numParticles) * 2 * Math.PI;
                    const radius = 180 + Math.random() * 40;
                    const tx = Math.cos(angle) * radius;
                    const ty = Math.sin(angle) * radius;
                    p.style.setProperty('--tx', `${tx}px`);
                    p.style.setProperty('--ty', `${ty}px`);
                    p.style.left = '50%';
                    p.style.top = '50%';
                    p.style.transform = `translate(-50%, -50%)`;
                    p.style.animationDelay = `${Math.random() * 10}s`;
                    container.appendChild(p);
                }
            }
            constructor() {
                this.pages = [
                    { id: 'home', title: 'üè† Updates', tooltip: 'View latest projects, news, and social media updates from DondlingerGC' },
                    { id: 'blueprints', title: 'üìê Plans', special: true, tooltip: 'Explore architectural blueprints and construction plans repository' },
                    { id: 'filemanager', title: 'üìÅ File Manager', special: true, tooltip: 'Browse and manage files transferred from your mobile device' },
                    { id: 'contact', title: 'üìß Contact', file: 'contact.html', tooltip: 'Get in touch with us to discuss your project needs' },
                    { id: 'fortress', title: 'üé® Website Builder', embed: 'fortress.html', embedTitle: 'Web Design Wizard', tooltip: 'Interactive web design tool to build your custom website' },
                    { id: 'chat', title: 'üí¨ Chat', embed: 'chat.html', embedTitle: 'DGC Chat', tooltip: 'Live chat support and customer service portal' },
                    { id: 'transfers', title: 'üì• File Transfer', special: true, tooltip: 'Receive files uploaded from your mobile device' },
                    { id: 'taxidermy', title: 'ü¶å Taxidermy', embed: 'taxidermy.html', embedTitle: 'Wild Preserve Taxidermy', tooltip: 'Professional taxidermy services and wildlife preservation' },
                    { id: 'flappybird', title: 'üê¶ Flappy Bird', embedUrl: 'https://john2121-flappy-bird-revamped.static.hf.space', embedTitle: 'Flappy Bird Revamped', tooltip: 'Classic Flappy Bird game - tap to fly!' },
                    { id: 'tours', title: 'üó∫Ô∏è 3D Tours', special: true, tooltip: 'Explore Matterport 3D tours and virtual walkthroughs' },
                    { id: 'cottonthimble', title: 'üßµ Cotton Thimble', embed: 'cottonthimble.html', embedTitle: 'Cotton Thimble Store Tour', tooltip: 'Virtual tour of Cotton Thimble store in WI - Grandma\'s family store' },
                    { id: 'settings', title: '‚öôÔ∏è Settings', special: true, tooltip: 'Customize your desktop theme, colors, and preferences' }
                ];

                this.state = {
                    openApps: new Set(),
                    activeApp: null,
                    minimizedApps: new Set(),
                    tooltipsEnabled: false,
                    lastRemoteCommandId: parseInt(localStorage.getItem('lastRemoteCommandId') || '0'),
                    zIndex: 100,
                    carnivalIndex: 0
                };

                this.sessionID = 'default';
                // Use local server for testing, production uses relative path
                this.bridgeURL = window.location.hostname === 'localhost' ? 'http://localhost:8787/api/bridge' : '/api/bridge';

                this.init();
                // Listen for hash changes
                window.addEventListener('hashchange', () => this.openWindowFromHash());
            }

            init() {
                try {
                // Check if we are in Mobile P2P File Transfer mode
                if (this.checkMobileP2PMode()) return;

                // Always start services for command polling, regardless of mobile/desktop
                this.startServices();

                // If purely a mobile visitor (small screen) but NOT doing file transfer, let CSS handle showing the static page content
                // UPDATED: Allow slightly permissive threshold or user will be stuck in fallback
                if (window.innerWidth < 600) return; 

                document.getElementById('desktop').style.display = 'block';
                const pageContent = document.querySelector('.page-content');
                if (pageContent) pageContent.style.display = 'none';

                this.renderDesktop();
                this.applySavedSettings();
                this.openWindowFromHash();
                } catch(e) {
                    console.error('System Init Failed:', e);
                    // alert('System Init Failed: ' + e.message); // Optional debug
                }
            }

            checkMobileP2PMode() {
                const urlParams = new URLSearchParams(window.location.search);
                const isMobileMode = urlParams.get('mobile') === '1';
                const sessionId = urlParams.get('session');
                const hasOffer = urlParams.get('offer'); // Legacy check

                if (isMobileMode || sessionId || hasOffer) {
                    console.log('Mobile P2P Mode detected.', { sessionId, hasOffer });
                    
                    // Force mobile styling override
                    document.documentElement.style.overflow = 'auto';
                    document.body.style.overflow = 'auto'; // ALLOW SCROLLING on mobile
                    document.body.style.background = '#111';
                    document.body.style.color = '#fff';
                    
                    // Hide everything else
                    document.getElementById('desktop').style.display = 'none';
                    const pageContent = document.querySelector('.page-content');
                    if (pageContent) pageContent.style.display = 'none';
                    
                    // Hide widgets
                    const widget = document.getElementById('cottonthimble-widget');
                    if (widget) widget.style.display = 'none';

                    // Inject Mobile P2P Interface
                    const mobileContainer = document.createElement('div');
                    mobileContainer.id = 'mobile-p2p-interface';
                    mobileContainer.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        overflow-y: auto;
                        z-index: 999999;
                        background: #0a0a0a;
                        padding: 24px;
                        box-sizing: border-box;
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                        text-align: center;
                        color: #fff;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    `;

                    mobileContainer.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≤</div>
                        <h2 style="margin-bottom: 0.5rem; font-size: 1.8rem;">Secure File Transfer</h2>
                        <p style="color: #aaa; margin-bottom: 2rem;">Direct Peer-to-Peer Connection</p>

                        <div id="p2p-status" style="
                            padding: 16px;
                            background: #222;
                            border-radius: 12px;
                            width: 100%;
                            margin-bottom: 24px;
                            border: 1px solid #333;
                        ">
                            <div id="status-icon" style="font-size: 2rem; margin-bottom: 8px;">üîÑ</div>
                            <div id="status-text" style="font-weight: bold;">Initializing...</div>
                        </div>

                        <div id="upload-section" style="display: none; width: 100%;">
                            <label for="file-input" style="
                                display: block;
                                background: #007bff;
                                color: white;
                                padding: 20px;
                                border-radius: 16px;
                                font-size: 1.2rem;
                                font-weight: bold;
                                cursor: pointer;
                                transition: transform 0.2s;
                                box-shadow: 0 4px 12px rgba(0,123,255,0.4);
                                margin-bottom: 16px;
                            ">
                                üì§ Select Files to Send
                            </label>
                            <input type="file" id="file-input" multiple style="display: none;">
                            <div id="file-list" style="text-align: left; color: #ccc; padding: 10px;"></div>
                        </div>

                        <div id="error-log" style="color: #ff4444; margin-top: 20px; font-family: monospace; font-size: 0.8rem; word-break: break-all;"></div>
                    `;

                    // DO NOT wipe body, it kills scripts. 
                    // Instead, we just append the overlay which covers everything.
                    // document.body.innerHTML = ''; 
                    
                    // Remove any existing overlay if we ran this twice
                    const existing = document.getElementById('mobile-p2p-interface');
                    if (existing) existing.remove();

                    document.body.appendChild(mobileContainer);

                    // Initialize Bridge Client
                    setTimeout(() => {
                        if (window.BridgeClient) {
                            const statusText = document.getElementById('status-text');
                            const statusIcon = document.getElementById('status-icon');
                            const uploadSection = document.getElementById('upload-section');
                            const errorLog = document.getElementById('error-log');

                            // Setup Local Bridge Client
                        window.BridgeClient.onStatusChange = (status) => {
                            statusText.textContent = status;
                            if (status.includes('Connected')) {
                                statusIcon.textContent = '‚úÖ';
                                statusText.style.color = '#4caf50';
                                uploadSection.style.display = 'block';
                            } else if (status.includes('Error') || status.includes('Disconnected')) {
                                statusIcon.textContent = '‚ùå';
                                statusText.style.color = '#ff4444';
                            } else {
                                statusIcon.textContent = 'üîÑ';
                                statusText.style.color = '#fff';
                            }
                        };
                        
                        // Instantiate client if not already
                        this.bridgeURL = window.location.hostname === 'localhost' ? 'http://localhost:8787/api/bridge' : '/api/bridge';
                        const client = new BridgeClient();
                        window.BridgeClient = client; // Bind to window for debug

                        // 1. SIGNALING SERVER FLOW (New)
                        if (sessionId) {
                            statusText.textContent = 'Connecting via Signal Server...';
                            
                            // Poll for 'initiator' (Desktop) offer
                            this._stopPolling = false;
                            this.pollSignals(sessionId, 0, async (signals) => {
                                for(const s of signals) {
                                    if(s.sender === 'initiator') {
                                        if (s.type === 'offer') {
                                            console.log('‚úÖ Received Offer from Desktop');
                                            statusText.textContent = 'Connecting...';
                                            
                                            // Provide function to send answer back
                                            await client.acceptOffer(s.content, async (answerSignal) => {
                                                await this.sendSignal(sessionId, {
                                                    type: answerSignal.type, 
                                                    sender: 'remote', 
                                                    content: answerSignal.sdp || answerSignal.candidate
                                                });
                                            });
                                        } else if (s.type === 'ice') {
                                            await client.addIceCandidate(s.content);
                                        }
                                    }
                                }
                            });
                        } 
                        // 2. LEGACY QR FLOW (Old)
                        else if (hasOffer) {
                            try {
                                const offerData = JSON.parse(decodeURIComponent(hasOffer));
                                statusText.textContent = 'Connecting... Generatng Answer...';
                                const offerSdp = offerData.offer || offerData;

                                client.acceptOffer(offerSdp, (signal) => {
                                    if (signal.type === 'answer') {
                                        // Display Answer QR Code
                                        statusText.textContent = 'Scan this on Desktop to Finish';
                                        statusIcon.textContent = 'üì≤';
                                        
                                        const existingQr = document.getElementById('answer-qr');
                                        if (existingQr) existingQr.remove();

                                        const qrDiv = document.createElement('div');
                                        qrDiv.id = 'answer-qr';
                                        qrDiv.style.background = 'white';
                                        qrDiv.style.padding = '16px';
                                        qrDiv.style.borderRadius = '8px';
                                        qrDiv.style.marginTop = '16px';
                                        qrDiv.style.display = 'inline-block';
                                        
                                        const p2pStatus = document.getElementById('p2p-status');
                                        p2pStatus.appendChild(qrDiv);
                                        
                                        new QRCode(qrDiv, {
                                            text: JSON.stringify({ answer: signal.sdp }),
                                            width: 256,
                                            height: 256,
                                            correctLevel: QRCode.CorrectLevel.L
                                        });
                                    }
                                });
                            } catch (e) {
                                statusText.textContent = 'Invalid Link';
                                errorLog.textContent = e.message;
                            }
                        } else {
                            statusText.textContent = 'Waiting to connect...';
                        }

                        // File Input Handler
                        const fileInput = document.getElementById('file-input');
                        fileInput.addEventListener('change', async (e) => {
                            const files = Array.from(e.target.files);
                            if (files.length === 0) return;

                            const fileList = document.getElementById('file-list');
                            fileList.innerHTML = files.map(f => `<div>üìÑ ${f.name} (${(f.size/1024).toFixed(1)} KB)</div>`).join('');

                            statusText.textContent = `Sending ${files.length} files...`;
                            
                            for (const file of files) {
                                try {
                                    await client.sendFile(file);
                                } catch (err) {
                                    console.error('Upload error:', err);
                                    errorLog.textContent += `Failed to send ${file.name}: ${err.message}\n`;
                                }
                            }
                            
                            statusText.textContent = '‚úÖ All files sent!';
                            setTimeout(() => {
                                statusText.textContent = 'Connected & Ready';
                                fileList.innerHTML = '';
                                fileInput.value = ''; // Reset
                            }, 3000);
                        });
                    } else {
                        const err = document.getElementById('error-log');
                        if(err) err.textContent = 'BridgeClient library not loaded.';
                    }
                    }, 500);

                    return true; // Stop normal init
                }
                return false;
            }

            isMobile() {
                return window.innerWidth < 768;
            }

            renderDesktop() {
                const startMenuItems = document.getElementById('start-menu-items');
                if (!startMenuItems) return;

                this.pages.forEach((page) => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'start-menu-item';
                    menuItem.textContent = page.title;
                    menuItem.onclick = () => this.openWindow(page.id);
                    startMenuItems.appendChild(menuItem);
                });

                setInterval(() => {
                    this.updateClock();
                    this.animateClockParticles();
                }, 1000);
                this.updateClock();
                this.animateClockParticles();

                // Setup Start Button
                const startBtn = document.querySelector('.start-button');
                if (startBtn) {
                    startBtn.onclick = () => this.toggleStartMenu();
                }

                // Global click to close menus
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.start-button') && !e.target.closest('.start-menu')) {
                        document.getElementById('start-menu')?.classList.remove('show');
                    }
                });
            }

            toggleStartMenu() {
                document.getElementById('start-menu').classList.toggle('show');
            }

            openWindow(id) {
                let win = document.getElementById(`${id}-window`);
                if (!win) {
                    this.createWindowElements(id);
                    win = document.getElementById(`${id}-window`);
                }
                if (!win) return;

                this.state.openApps.add(id);
                this.state.minimizedApps.delete(id);
                this.state.activeApp = id;

                win.classList.add('active');
                win.classList.remove('minimized');
                win.style.zIndex = ++this.state.zIndex;

                // Update hash for shareability
                window.location.hash = `#${id}`;

                document.getElementById('start-menu')?.classList.remove('show');
                this.updateTaskbar();
                this.syncState();
            }

            createWindowElements(id) {
                const page = this.pages.find(p => p.id === id);
                if (!page) return;

                const container = document.getElementById('windows-container');
                const win = document.createElement('div');
                win.className = 'window';
                win.id = `${id}-window`;
                win.style.cssText = `top: 100px; left: 100px; width: min(85%, 750px); height: min(75%, 550px);`;

                win.innerHTML = `
                    <div class="window-header">
                        <span>${page.title}</span>
                        <div class="window-controls">
                            <div class="window-control" onclick="System.closeWindow('${page.id}')"></div>
                            <div class="window-control" onclick="System.minimizeWindow('${page.id}')"></div>
                            <div class="window-control" onclick="System.maximizeWindow('${page.id}')"></div>
                        </div>
                    </div>
                    <div class="window-content" id="${page.id}-content">Loading...</div>
                `;
                container.appendChild(win);
                this.setupDragging(win);
                this.loadWindowContent(page);
            }

            loadWindowContent(page) {
                const contentEl = document.getElementById(`${page.id}-content`);
                if (!contentEl) return;

                if (page.id === 'home') {
                    contentEl.innerHTML = this.getHomeHTML();
                } else if (page.id === 'tours') {
                    this.initTours(contentEl);
                } else if (page.id === 'transfers') {
                    this.initFileTransfers(contentEl);
                } else if (page.id === 'filemanager') {
                    window.fileManager = new FileManager();
                    window.fileManager.onWindowOpen();
                } else if (page.embed || page.embedUrl) {
                    const url = page.embed || page.embedUrl;
                    contentEl.innerHTML = `<iframe src="${url}" style="width:100%;height:100%;border:none;background:#fff;"></iframe>`;
                } else if (page.id === 'blueprints') {
                    this.initBlueprints(contentEl);
                } else if (page.id === 'carnival') {
                    this.initCarnival(contentEl);
                } else if (page.id === 'settings') {
                    this.initSettings(contentEl);
                } else if (page.file) {
                    fetch(page.file).then(r => r.text()).then(html => {
                        const temp = document.createElement('div');
                        temp.innerHTML = html;
                        const main = temp.querySelector('#main-content');
                        contentEl.innerHTML = main ? main.innerHTML : html;
                    }).catch(() => contentEl.innerHTML = 'Error loading content.');
                }
            }

            closeWindow(id) {
                const win = document.getElementById(`${id}-window`);
                if (win) {
                    win.classList.remove('active');
                    this.state.openApps.delete(id);
                    this.updateTaskbar();
                    this.syncState();
                }
            }

            minimizeWindow(id) {
                const win = document.getElementById(`${id}-window`);
                if (win) {
                    win.classList.add('minimized');
                    this.state.minimizedApps.add(id);
                    this.updateTaskbar();
                    this.syncState();
                }
            }

            maximizeWindow(id) {
                const win = document.getElementById(`${id}-window`);
                if (win) win.classList.toggle('maximized');
            }

            restoreWindow(id) {
                const win = document.getElementById(`${id}-window`);
                if (win) {
                    win.classList.remove('minimized');
                    this.state.minimizedApps.delete(id);
                    this.updateTaskbar();
                    this.syncState();
                }
            }

            splitWindowLeft(id) {
                const win = document.getElementById(`${id}-window`);
                if (win) {
                    win.style.left = '0';
                    win.style.width = '50vw';
                    win.style.height = '100vh';
                    win.style.top = '0';
                }
            }

            splitWindowRight(id) {
                const win = document.getElementById(`${id}-window`);
                if (win) {
                    win.style.left = '50vw';
                    win.style.width = '50vw';
                    win.style.height = '100vh';
                    win.style.top = '0';
                }
            }

            toggleTooltips() {
                this.state.tooltipsEnabled = !this.state.tooltipsEnabled;
                const toggle = document.getElementById('tooltip-toggle');
                if (toggle) {
                    toggle.textContent = `üí° Tooltips: ${this.state.tooltipsEnabled ? 'ON' : 'OFF'}`;
                }
            }

            updateTaskbar() {
                const taskbarApps = document.getElementById('taskbar-apps');
                if (!taskbarApps) return;
                taskbarApps.innerHTML = '';
                this.state.openApps.forEach(id => {
                    const page = this.pages.find(p => p.id === id);
                    const task = document.createElement('div');
                    task.className = 'taskbar-app' + (this.state.minimizedApps.has(id) ? ' minimized' : ' active');
                    task.textContent = page ? page.title : id;
                    task.onclick = () => this.openWindow(id);
                    taskbarApps.appendChild(task);
                });
            }

            startServices() {
                setInterval(() => this.pollRemoteCommands(), 3000);
            }

            async pollRemoteCommands() {
                try {
                    const res = await fetch(`${this.bridgeURL}?action=pull&sessionId=${this.sessionID}`);
                    if (!res.ok) return;
                    const cmd = await res.json();
                    if (cmd && cmd.timestamp > this.state.lastRemoteCommandId) {
                        this.state.lastRemoteCommandId = cmd.timestamp;
                        localStorage.setItem('lastRemoteCommandId', cmd.timestamp);
                        this.executeCommand(cmd);
                    }
                } catch (e) { }
            }

            executeCommand(cmd) {
                const { type, payload } = cmd;
                switch (type) {
                    case 'OPEN_APP': this.openWindow(payload.id); break;
                    case 'CLOSE_APP': this.closeWindow(payload.id); break;
                    case 'RELOAD': location.reload(); break;
                    case 'ALERT': alert(payload.message); break;
                }
            }

            async syncState() {
                try {
                    await fetch(`${this.bridgeURL}?action=sync&sessionId=${this.sessionID}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            openApps: Array.from(this.state.openApps),
                            minimizedApps: Array.from(this.state.minimizedApps),
                            activeApp: this.state.activeApp,
                            timestamp: Date.now()
                        })
                    });
                } catch (e) { }
            }

            updateClock() {
                const now = new Date();
                // Update taskbar clock
                const clock = document.getElementById('clock');
                if (clock) clock.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Update animated clock display
                const hours = document.getElementById('hours');
                const minutes = document.getElementById('minutes');
                const seconds = document.getElementById('seconds');
                if (hours) hours.textContent = String(now.getHours()).padStart(2, '0');
                if (minutes) minutes.textContent = String(now.getMinutes()).padStart(2, '0');
                if (seconds) seconds.textContent = String(now.getSeconds()).padStart(2, '0');

                // Update date display
                const dateDisplay = document.getElementById('date-display');
                if (dateDisplay) {
                    dateDisplay.textContent = now.toLocaleDateString(undefined, {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                    });
                }
            }

            setupDragging(win) {
                const header = win.querySelector('.window-header');
                let isDragging = false;
                header.onmousedown = (e) => {
                    if (e.target.closest('.window-controls')) return;
                    isDragging = true;
                    let startX = e.clientX - win.offsetLeft;
                    let startY = e.clientY - win.offsetTop;
                    const onMove = (e) => {
                        if (!isDragging) return;
                        win.style.left = (e.clientX - startX) + 'px';
                        win.style.top = (e.clientY - startY) + 'px';
                    };
                    const onUp = () => {
                        isDragging = false;
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                    };
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                };
            }

            getHomeHTML() {
                return `
                    <div style="padding:24px;overflow-y:auto;height:100%;">
                        <div style="text-align:center;margin-bottom:32px;">
                            <h2 style="color:var(--accent);margin:0 0 12px 0;font-size:2.2rem;">üì¢ Latest Updates</h2>
                            <p style="color:#666;">Stay connected with our latest projects and announcements.</p>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center;gap:32px;">
                            <iframe src="https://www.facebook.com/plugins/post.php?href=https%3A%2F%2Fwww.facebook.com%2Fpermalink.php%3Fstory_fbid%3Dpfbid02b4zEEqF4LFq2HAG6izPkimicUSU7dG27Fe3y3YfP4SCcaw2aTRkFgG51V2WDbxSEl%26id%3D61550821937890&show_text=true&width=500" width="500" height="661" style="border:none;border-radius:8px;" scrolling="no" frameborder="0" allowfullscreen="true"></iframe>
                        </div>
                    </div>
                `;
            }

            initBlueprints(container) {
                container.innerHTML = `<div id="blueprints-viewer"><h2>Architectural Blueprints</h2><div class="blueprints-list" style="display:flex;flex-wrap:wrap;gap:24px;"></div><div class="blueprint-preview" style="margin-top:32px;padding:24px;background:#f7f7fa;border-radius:10px;border:2px solid var(--accent);"></div><p style="margin-top:32px;color:var(--muted);font-size:15px;">All blueprints and plans are property of Dondlinger General Contracting. For demonstration only.</p></div>`;
                fetch('blueprints.json').then(r => r.json()).then(blueprints => {
                    const list = container.querySelector('.blueprints-list');
                    const preview = container.querySelector('.blueprint-preview');
                    list.innerHTML = '';

                    blueprints.forEach((bp, idx) => {
                        const item = document.createElement('div');
                        item.className = 'blueprint-thumb';
                        item.style = 'width:180px;cursor:pointer;border:2px solid var(--accent);border-radius:10px;background:#f7f7fa;box-shadow:0 2px 12px rgba(0,212,255,0.2);overflow:hidden;transition:box-shadow 0.2s, transform 0.2s;';

                        item.innerHTML = `
                            <div style="height:120px;display:flex;align-items:center;justify-content:center;background:#e0e0e0;">
                                ${bp.type === 'pdf' ? '<span style=\'color:var(--accent);font-size:2.5em;\'>üìÑ</span>' : `<img src='blueprints/${bp.filename}' alt='${bp.title}' style='max-width:100%;max-height:100px;display:block;margin:auto;' onerror="this.parentElement.innerHTML='<span style=\\'color:var(--accent);font-size:2.5em;\\'>üìê</span>'">`}
                            </div>
                            <div style="padding:10px 8px 8px 8px;">
                                <div style="font-weight:700;font-size:1em;color:var(--accent);">${bp.title}</div>
                                <div style="font-size:0.95em;color:var(--muted);margin-top:2px;">${bp.description}</div>
                            </div>
                        `;

                        item.onmouseenter = () => item.style.transform = 'translateY(-4px)';
                        item.onmouseleave = () => item.style.transform = 'translateY(0)';

                        item.onclick = () => {
                            list.querySelectorAll('.blueprint-thumb').forEach(el => {
                                el.style.boxShadow = '0 2px 12px rgba(0,212,255,0.2)';
                                el.style.borderColor = 'var(--accent)';
                            });
                            item.style.boxShadow = '0 0 0 3px var(--accent), 0 2px 12px rgba(0,212,255,0.6)';
                            item.style.borderColor = 'var(--accent)';

                            preview.innerHTML = bp.type === 'pdf'
                                ? `<embed src='blueprints/${bp.filename}#toolbar=0' type='application/pdf' style='width:100%;min-height:500px;border-radius:10px;background:#fff;' />`
                                : `<img src='blueprints/${bp.filename}' alt='${bp.title}' style='max-width:100%;border-radius:10px;background:#fff;box-shadow:0 2px 12px rgba(0,212,255,0.2);' onerror="this.parentElement.innerHTML='<div style=\\'color:var(--muted); text-align:center;\\'>Preview not available<br>Project: ${bp.title}</div>'">`;
                        };

                        list.appendChild(item);
                        if (idx === 0) item.onclick();
                    });
                }).catch(err => {
                    container.innerHTML = '<div style="color:#c00;text-align:center;padding:40px;">Failed to load blueprints. Please try again later.</div>';
                    console.error('Blueprints load error:', err);
                });
            }

            initFileTransfers(container) {
                container.innerHTML = `
                    <div id="transfers-viewer" style="padding:24px;height:100%;display:flex;flex-direction:column;overflow-y:auto;">
                        <div style="margin-bottom:24px;">
                            <h2 style="color:var(--accent);margin:0 0 8px 0;font-size:2rem;">üì• File Transfer</h2>
                            <p style="color:#666;font-size:0.95rem;margin:0;">Scan the QR code with your mobile device to upload files</p>
                        </div>

                        <div style="background:linear-gradient(135deg, rgba(0,212,255,0.1) 0%, rgba(0,212,255,0.05) 100%);border-radius:16px;padding:24px;border:2px solid var(--accent);margin-bottom:24px;">
                            <h3 style="color:var(--accent);margin:0 0 12px 0;font-size:1.2rem;">üì± Mobile Upload</h3>
                            <p style="color:#666;font-size:0.95rem;line-height:1.6;margin:0;">
                                <strong>Step 1:</strong> Click the "üì± Mobile" button in the top-right corner<br>
                                <strong>Step 2:</strong> Scan the QR code with any mobile device<br>
                                <strong>Step 3:</strong> Upload files from your phone - they'll appear here in real-time
                            </p>
                        </div>

                        <div style="background:rgba(30,41,59,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:20px;flex:1;overflow-y:auto;">
                            <h3 style="color:#e2e8f0;margin:0 0 16px 0;font-size:1.1rem;">üìÇ Received Files</h3>
                            <div id="files-list" style="display:flex;flex-direction:column;gap:12px;">
                                <div style="text-align:center;padding:40px 20px;color:#94a3b8;">
                                    <div style="font-size:3rem;margin-bottom:12px;">‚è≥</div>
                                    <p style="margin:0;font-size:0.95rem;">Waiting for file uploads...</p>
                                    <p style="margin:8px 0 0 0;font-size:0.85rem;color:#64748b;">Files will appear here when uploaded from mobile</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Start polling for files
                this.pollForFiles(container);
            }

            pollForFiles(container) {
                const filesList = container.querySelector('#files-list');
                if (!filesList) return;

                const poll = () => {
                    fetch(`${this.bridgeURL}?action=pull&sessionId=${this.sessionID}`)
                        .then(r => r.json())
                        .then(cmd => {
                            if (cmd && cmd.type === 'file_upload' && cmd.file) {
                                const fileItem = document.createElement('div');
                                fileItem.style.cssText = 'background:rgba(15,23,42,0.8);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;animation:slideIn 0.3s ease;';

                                const fileName = cmd.file.name || 'Unknown File';
                                const fileSize = cmd.file.size ? (cmd.file.size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown Size';

                                fileItem.innerHTML = `
                                    <div style="flex:1;min-width:0;">
                                        <div style="color:#e2e8f0;font-weight:600;word-break:break-all;">${this.escapeHtml(fileName)}</div>
                                        <div style="color:#94a3b8;font-size:0.85rem;margin-top:4px;">${fileSize}</div>
                                    </div>
                                    <button onclick="window.System.downloadFile(this)" data-file="${this.escapeHtml(fileName)}" data-data="${cmd.file.data}" style="padding:8px 16px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;white-space:nowrap;font-size:0.9rem;">‚¨áÔ∏è Download</button>
                                `;

                                // Add style for animation if not exists
                                if (!document.getElementById('transfer-animation-style')) {
                                    const style = document.createElement('style');
                                    style.id = 'transfer-animation-style';
                                    style.textContent = '@keyframes slideIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }';
                                    document.head.appendChild(style);
                                }

                                if (filesList.querySelector('[data-empty]')) {
                                    filesList.innerHTML = '';
                                }
                                filesList.insertBefore(fileItem, filesList.firstChild);
                            }
                        })
                        .catch(err => console.log('Poll error:', err));

                    setTimeout(poll, 1000); // Poll every second
                };

                poll();
            }

            downloadFile(button) {
                const fileName = button.dataset.file;
                const base64Data = button.dataset.data;

                if (!base64Data) return;

                try {
                    const binaryString = atob(base64Data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const blob = new Blob([bytes]);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.error('Download error:', e);
                    alert('Error downloading file');
                }
            }

            escapeHtml(text) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            initCarnival(container) {
                const CARNIVAL_SPACES = [
                    { url: 'https://huggingface.co/spaces/John2121/lawconnect-legal-services', title: 'LawConnect Legal Services', desc: 'Professional legal services platform with AI-powered assistance for connecting clients with attorneys', icon: '‚öñÔ∏è' },
                    { url: 'https://huggingface.co/spaces/John2121/italia-s-romano-s-too', title: "Italia's Romano's Too", desc: 'Authentic Italian restaurant website with menu, reservations, and online ordering', icon: 'üçù' },
                    { url: 'https://huggingface.co/spaces/John2121/dondlingergc-digital-fortress-builder', title: 'Digital Fortress Builder', desc: 'Interactive drag-and-drop website builder with live preview and customization', icon: 'üè∞' },
                    { url: 'https://huggingface.co/spaces/John2121/bistrobyte', title: 'BistroByte', desc: 'Modern restaurant tech platform with smart ordering and kitchen management', icon: 'üçî' },
                    { url: 'https://huggingface.co/spaces/John2121/GhostScriptMCP', title: 'GhostScript MCP', desc: 'Advanced automation scripting interface with AI-powered code generation', icon: 'üëª' },
                    { url: 'https://huggingface.co/spaces/John2121/the-quilted-tapestry-emporium', title: 'The Quilted Tapestry Emporium', desc: 'Artisan quilting and textile showcase with custom design gallery', icon: 'üßµ' }
                ];

                container.innerHTML = `
                    <div id="carnival-viewer" style="padding:24px;height:100%;display:flex;flex-direction:column;overflow-y:auto;">
                        <div style="text-align:center;margin-bottom:24px;">
                            <h2 style="color:var(--accent);margin:0 0 8px 0;font-size:2rem;">üé™ Digital Carnival</h2>
                            <p style="color:#666;font-size:0.95rem;margin:0;">Weird, wonderful, and experimental web demos from the lab</p>
                        </div>
                        <div id="carnival-card" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(0,212,255,0.1) 0%, rgba(0,212,255,0.05) 100%);border-radius:16px;padding:40px;border:2px solid var(--accent);box-shadow:0 8px 24px rgba(0,212,255,0.2);min-height:400px;">
                            <div style="text-align:center;max-width:600px;">
                                <div style="font-size:4rem;margin-bottom:20px;" id="carnival-icon">üé™</div>
                                <h3 style="color:var(--accent);font-size:1.8rem;margin:0 0 12px 0;" id="carnival-title">Loading...</h3>
                                <p style="color:#666;font-size:1.05rem;line-height:1.6;margin:0 0 32px 0;" id="carnival-desc">Please wait...</p>
                                <a id="carnival-link" href="#" target="_blank" style="display:inline-block;padding:16px 40px;background:var(--accent);color:#000;font-weight:700;text-decoration:none;border-radius:12px;font-size:1.1rem;box-shadow:0 4px 12px rgba(0,212,255,0.4);transition:all 0.2s;cursor:pointer;">
                                    üöÄ Launch Demo in New Tab
                                </a>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-top:20px;">
                            <button onclick="window.System.prevCarnival()" style="padding:12px 24px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:1.05rem;">‚Üê Prev</button>
                            <div id="carnival-dots" style="display:flex;gap:8px;"></div>
                            <button onclick="window.System.nextCarnival()" style="padding:12px 24px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:1.05rem;">Next ‚Üí</button>
                        </div>
                    </div>
                `;

                // Load first space
                setTimeout(() => this.loadCarnival(0), 100);
            }

            loadCarnival(index) {
                const CARNIVAL_SPACES = [
                    { url: 'https://huggingface.co/spaces/John2121/lawconnect-legal-services', title: 'LawConnect Legal Services', desc: 'Professional legal services platform with AI-powered assistance for connecting clients with attorneys', icon: '‚öñÔ∏è' },
                    { url: 'https://huggingface.co/spaces/John2121/italia-s-romano-s-too', title: "Italia's Romano's Too", desc: 'Authentic Italian restaurant website with menu, reservations, and online ordering', icon: 'üçù' },
                    { url: 'https://huggingface.co/spaces/John2121/dondlingergc-digital-fortress-builder', title: 'Digital Fortress Builder', desc: 'Interactive drag-and-drop website builder with live preview and customization', icon: 'üè∞' },
                    { url: 'https://huggingface.co/spaces/John2121/bistrobyte', title: 'BistroByte', desc: 'Modern restaurant tech platform with smart ordering and kitchen management', icon: 'üçî' },
                    { url: 'https://huggingface.co/spaces/John2121/GhostScriptMCP', title: 'GhostScript MCP', desc: 'Advanced automation scripting interface with AI-powered code generation', icon: 'üëª' },
                    { url: 'https://huggingface.co/spaces/John2121/the-quilted-tapestry-emporium', title: 'The Quilted Tapestry Emporium', desc: 'Artisan quilting and textile showcase with custom design gallery', icon: 'üßµ' }
                ];

                this.state.carnivalIndex = index;
                const space = CARNIVAL_SPACES[index];
                document.getElementById('carnival-icon').textContent = space.icon;
                document.getElementById('carnival-link').href = space.url;
                document.getElementById('carnival-title').textContent = space.title;
                document.getElementById('carnival-desc').textContent = space.desc;

                // Update dots
                const dots = document.getElementById('carnival-dots');
                if (dots) {
                    dots.innerHTML = '';
                    CARNIVAL_SPACES.forEach((_, i) => {
                        const dot = document.createElement('div');
                        dot.style.cssText = `width:12px;height:12px;border-radius:50%;cursor:pointer;transition:all 0.2s;${i === index ? 'background:var(--accent);transform:scale(1.3);' : 'background:#ccc;'}`;
                        dot.onclick = () => this.loadCarnival(i);
                        dots.appendChild(dot);
                    });
                }
            }

            nextCarnival() {
                const CARNIVAL_SPACES = [
                    { url: 'https://huggingface.co/spaces/John2121/lawconnect-legal-services', title: 'LawConnect Legal Services', desc: 'Professional legal services platform with AI-powered assistance for connecting clients with attorneys', icon: '‚öñÔ∏è' },
                    { url: 'https://huggingface.co/spaces/John2121/italia-s-romano-s-too', title: "Italia's Romano's Too", desc: 'Authentic Italian restaurant website with menu, reservations, and online ordering', icon: 'üçù' },
                    { url: 'https://huggingface.co/spaces/John2121/dondlingergc-digital-fortress-builder', title: 'Digital Fortress Builder', desc: 'Interactive drag-and-drop website builder with live preview and customization', icon: 'üè∞' },
                    { url: 'https://huggingface.co/spaces/John2121/bistrobyte', title: 'BistroByte', desc: 'Modern restaurant tech platform with smart ordering and kitchen management', icon: 'üçî' },
                    { url: 'https://huggingface.co/spaces/John2121/GhostScriptMCP', title: 'GhostScript MCP', desc: 'Advanced automation scripting interface with AI-powered code generation', icon: 'üëª' },
                    { url: 'https://huggingface.co/spaces/John2121/the-quilted-tapestry-emporium', title: 'The Quilted Tapestry Emporium', desc: 'Artisan quilting and textile showcase with custom design gallery', icon: 'üßµ' }
                ];
                this.loadCarnival((this.state.carnivalIndex + 1) % CARNIVAL_SPACES.length);
            }

            prevCarnival() {
                const CARNIVAL_SPACES = [
                    { url: 'https://huggingface.co/spaces/John2121/lawconnect-legal-services', title: 'LawConnect Legal Services', desc: 'Professional legal services platform with AI-powered assistance for connecting clients with attorneys', icon: '‚öñÔ∏è' },
                    { url: 'https://huggingface.co/spaces/John2121/italia-s-romano-s-too', title: "Italia's Romano's Too", desc: 'Authentic Italian restaurant website with menu, reservations, and online ordering', icon: 'üçù' },
                    { url: 'https://huggingface.co/spaces/John2121/dondlingergc-digital-fortress-builder', title: 'Digital Fortress Builder', desc: 'Interactive drag-and-drop website builder with live preview and customization', icon: 'üè∞' },
                    { url: 'https://huggingface.co/spaces/John2121/bistrobyte', title: 'BistroByte', desc: 'Modern restaurant tech platform with smart ordering and kitchen management', icon: 'üçî' },
                    { url: 'https://huggingface.co/spaces/John2121/GhostScriptMCP', title: 'GhostScript MCP', desc: 'Advanced automation scripting interface with AI-powered code generation', icon: 'üëª' },
                    { url: 'https://huggingface.co/spaces/John2121/the-quilted-tapestry-emporium', title: 'The Quilted Tapestry Emporium', desc: 'Artisan quilting and textile showcase with custom design gallery', icon: 'üßµ' }
                ];
                this.loadCarnival((this.state.carnivalIndex - 1 + CARNIVAL_SPACES.length) % CARNIVAL_SPACES.length);
            }

            initTours(container) {
                const saved = JSON.parse(localStorage.getItem('matterportTours') || 'null');
                this.tours = saved || [
                    { title: 'Main Property', url: 'https://my.matterport.com/show/?m=7Cfk3WA9AN7&brand=0' },
                    { title: 'Property 2', url: '' }
                ];
                this.tourIndex = 0;

                container.innerHTML = `
                    <div id="tours-viewer" style="padding:24px;height:100%;display:flex;flex-direction:column;overflow-y:auto;">
                        <div style="text-align:center;margin-bottom:16px;">
                            <h2 style="color:var(--accent);margin:0 0 8px 0;font-size:2rem;">üó∫Ô∏è 3D Tours</h2>
                            <p style="color:#666;margin:0;font-size:0.95rem;">Virtual walkthroughs (Matterport) ‚Äî use the controls below to switch tours or paste a link to add another.</p>
                        </div>

                        <div id="tours-card" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(0,212,255,0.05) 0%, rgba(0,212,255,0.02) 100%);border-radius:16px;padding:20px;border:2px solid var(--accent);box-shadow:0 8px 24px rgba(0,212,255,0.2);min-height:420px;">
                            <div id="tours-embed" style="width:100%;height:100%;max-height:640px;background:#fff;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;">
                                <div id="tours-embed-inner" style="width:100%;height:100%;"></div>
                            </div>
                        </div>

                        <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:18px;">
                            <button id="tours-prev" style="padding:10px 18px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;">‚Üê Prev</button>
                            <div id="tours-dots" style="display:flex;gap:8px;"></div>
                            <button id="tours-next" style="padding:10px 18px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;">Next ‚Üí</button>
                        </div>

                        <form id="tours-form" style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:16px;">
                            <input id="tours-url-input" placeholder="Paste Matterport show URL (https://my.matterport.com/show/?m=...)" style="width:60%;padding:8px;border-radius:8px;border:1px solid #ccc;">
                            <button id="tours-save" type="button" style="padding:8px 14px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;">Save</button>
                        </form>
                        <p id="tours-note" style="color:var(--muted);text-align:center;margin-top:10px;font-size:0.9rem;">Saved tours persist to your browser storage.</p>
                    </div>
                `;

                // Setup event handlers
                document.getElementById('tours-prev').onclick = () => this.prevTour();
                document.getElementById('tours-next').onclick = () => this.nextTour();
                document.getElementById('tours-save').onclick = () => {
                    const val = document.getElementById('tours-url-input').value.trim();
                    if (!val) return alert('Please paste a Matterport show URL.');
                    this.tours[this.tourIndex].url = val;
                    localStorage.setItem('matterportTours', JSON.stringify(this.tours));
                    this.renderToursDots();
                    this.loadTour(this.tourIndex);
                };

                this.renderToursDots();
                this.loadTour(this.tourIndex);
            }

            loadTour(index) {
                this.tourIndex = index;
                const tour = this.tours[index];
                const inner = document.getElementById('tours-embed-inner');
                const input = document.getElementById('tours-url-input');
                if (!inner) return;
                inner.innerHTML = '';
                if (!tour || !tour.url) {
                    inner.innerHTML = `<div style="text-align:center;color:#666;padding:32px;">No tour configured. Paste a Matterport show URL and click Save.</div>`;
                } else {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = '0';
                    iframe.src = tour.url;
                    iframe.allow = 'autoplay; fullscreen; web-share; xr-spatial-tracking';
                    iframe.allowFullscreen = true;
                    inner.appendChild(iframe);
                }
                if (input) input.value = tour ? tour.url || '' : '';
                // Update dots styling
                const dots = document.getElementById('tours-dots');
                if (dots) {
                    Array.from(dots.children).forEach((d, i) => {
                        d.style.cssText = `width:12px;height:12px;border-radius:50%;cursor:pointer;transition:all 0.2s;${i === index ? 'background:var(--accent);transform:scale(1.3);' : 'background:#ccc;'}`;
                    });
                }
            }

            renderToursDots() {
                const dots = document.getElementById('tours-dots');
                if (!dots) return;
                dots.innerHTML = '';
                this.tours.forEach((t, i) => {
                    const dot = document.createElement('div');
                    dot.onclick = () => this.loadTour(i);
                    dot.style.cssText = `width:12px;height:12px;border-radius:50%;cursor:pointer;transition:all 0.2s;${i === this.tourIndex ? 'background:var(--accent);transform:scale(1.3);' : 'background:#ccc;'}`;
                    dots.appendChild(dot);
                });
            }

            nextTour() {
                if (!this.tours || !this.tours.length) return;
                this.loadTour((this.tourIndex + 1) % this.tours.length);
            }

            prevTour() {
                if (!this.tours || !this.tours.length) return;
                this.loadTour((this.tourIndex - 1 + this.tours.length) % this.tours.length);
            }

            initSettings(container) {
                container.innerHTML = `
                    <form id="settings-form" style="padding:24px;">
                        <h2>Settings</h2>
                        <label>Accent Color: <input type="color" id="settings-accent" value="#00d4ff"></label>
                        <button type="submit">Save</button>
                    </form>
                `;
                container.querySelector('form').onsubmit = (e) => {
                    e.preventDefault();
                    const accent = document.getElementById('settings-accent').value;
                    localStorage.setItem('desktopSettings', JSON.stringify({ accent }));
                    this.applySavedSettings();
                };
            }

            applySavedSettings() {
                const saved = JSON.parse(localStorage.getItem('desktopSettings') || '{}');
                if (saved.accent) document.documentElement.style.setProperty('--accent', saved.accent);
            }

            startScanner() {
                if (typeof Html5Qrcode === 'undefined') {
                    alert('Scanner library not loaded yet. Please wait or refresh.');
                    return;
                }
                const readerContainer = document.getElementById('reader-container');
                const manualContainer = document.getElementById('manual-input-container');
                readerContainer.style.display = 'block';
                manualContainer.style.display = 'none';

                if (this.html5QrCode) return;

                this.html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                this.html5QrCode.start(
                    { facingMode: "user" }, 
                    config,
                    (decodedText) => {
                        console.log(`Scan success: ${decodedText}`);
                        this.stopScanner();
                        // Use the result
                        const input = document.getElementById('qr-answer-input');
                        if(input) input.value = decodedText;
                        this.handleManualAnswer();
                    },
                    (errorMessage) => { /* ignore per-frame failures */ }
                ).catch(err => {
                    console.error("Unable to start scanning", err);
                    alert("Camera start failed: " + err);
                    this.stopScanner();
                });
            }

            stopScanner() {
                 const readerContainer = document.getElementById('reader-container');
                 const manualContainer = document.getElementById('manual-input-container');
                 if(readerContainer) readerContainer.style.display = 'none';
                 if(manualContainer) manualContainer.style.display = 'block';

                 if (this.html5QrCode) {
                     this.html5QrCode.stop().then(() => {
                         this.html5QrCode.clear();
                         this.html5QrCode = null;
                     }).catch(err => console.error(err));
                 }
            }

            async handleManualAnswer() {
                const input = document.getElementById('qr-answer-input');
                if (!input || !input.value.trim()) return;
                
                try {
                    const answerData = JSON.parse(input.value.trim());
                    // Support { answer: "..." } or raw "..."
                    const answerSdp = answerData.answer || answerData;
                    
                    if (this._p2pBridgeClient) {
                         await this._p2pBridgeClient.acceptAnswer(answerSdp);
                         document.getElementById('qr-title').textContent = 'Connecting...';
                         // Visual feedback
                         input.value = 'Processing...';
                    }
                } catch (e) {
                    alert('Invalid configuration data: ' + e.message);
                }
            }

            // P2P Signaling Helpers
            async sendSignal(sessionId, signalData) {
                try {
                    console.log('üì§ Sending signal:', signalData.type);
                    await fetch(this.bridgeURL + '?action=store-signal&sessionId=' + sessionId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(signalData)
                    });
                } catch (e) {
                    console.error('Signal send failed', e);
                }
            }

            async pollSignals(sessionId, since = 0, onSignals) {
                if (this._stopPolling) return;
                try {
                    const res = await fetch(`${this.bridgeURL}?action=get-signals&sessionId=${sessionId}&since=${since}`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.signals && data.signals.length > 0) {
                            onSignals(data.signals);
                            // Update timestamp to last seen
                            const maxTs = Math.max(...data.signals.map(s => s.timestamp));
                            setTimeout(() => this.pollSignals(sessionId, maxTs, onSignals), 1000);
                        } else {
                            setTimeout(() => this.pollSignals(sessionId, since, onSignals), 1000);
                        }
                    } else {
                        setTimeout(() => this.pollSignals(sessionId, since, onSignals), 2000);
                    }
                } catch (e) {
                    console.error('Poll failed', e);
                    setTimeout(() => this.pollSignals(sessionId, since, onSignals), 3000);
                }
            }

            createDesktopIcon(fileBlob, fileName) {
                const desktop = document.getElementById('desktop');
                const fileUrl = URL.createObjectURL(fileBlob);
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'desktop-icon';
                // Random position near center for visibility
                const x = 100 + Math.random() * (window.innerWidth - 200);
                const y = 100 + Math.random() * (window.innerHeight - 200);
                
                iconDiv.style.cssText = `
                    position: absolute;
                    left: ${x}px;
                    top: ${y}px;
                    width: 80px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    cursor: pointer;
                    z-index: 10;
                    text-align: center;
                    color: white;
                    text-shadow: 0 1px 4px rgba(0,0,0,0.8);
                `;

                // Determine icon based on type
                let iconChar = 'üìÑ';
                if (fileName.match(/\.(jpg|jpeg|png|gif|webp)$/i)) iconChar = 'üñºÔ∏è';
                else if (fileName.match(/\.(mp4|webm)$/i)) iconChar = 'üé¨';
                else if (fileName.match(/\.(pdf)$/i)) iconChar = 'üìï';

                iconDiv.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 4px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));">${iconChar}</div>
                    <div style="font-size: 0.8rem; word-break: break-all; background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 4px;">${fileName}</div>
                `;

                // Double click to open/download
                iconDiv.ondblclick = () => {
                    const a = document.createElement('a');
                    a.href = fileUrl;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };

                // Drag functionality (simple)
                let isDragging = false;
                let startX, startY;

                iconDiv.onmousedown = (e) => {
                    isDragging = true;
                    startX = e.clientX - iconDiv.offsetLeft;
                    startY = e.clientY - iconDiv.offsetTop;
                    iconDiv.style.zIndex = 100;
                };

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    iconDiv.style.left = (e.clientX - startX) + 'px';
                    iconDiv.style.top = (e.clientY - startY) + 'px';
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    iconDiv.style.zIndex = 10;
                });

                desktop.appendChild(iconDiv);
                
                // Also add to file transfer history if window open
                const filesList = document.getElementById('files-list');
                if (filesList) {
                     const fileItem = document.createElement('div');
                     fileItem.innerHTML = `<div>New File: ${fileName}</div>`;
                     filesList.prepend(fileItem);
                }
            }

            // QR Code functionality - P2P FILE TRANSFER
            async generateQRCode(manualIp = null) {
                const qrContainer = document.getElementById('qr-code');
                if (!qrContainer) return;
                
                this._stopPolling = false;
                const sessionId = Math.random().toString(36).substring(2, 9); // Random 7-char ID
                this.currentSessionId = sessionId;

                // Check for localhost and prompt for IP if needed
                const hostname = window.location.hostname;
                const port = window.location.port ? ':' + window.location.port : '';
                const protocol = window.location.protocol;
                
                // If localhost or file:// protocol, prompt for LAN IP
                if (!manualIp && (['localhost', '127.0.0.1', '[::1]'].includes(hostname) || protocol === 'file:' || !hostname)) {
                     qrContainer.innerHTML = `
                         <div style="padding: 10px; color: #fff; text-align: center;">
                             <p style="color: #ffcc00; font-weight: bold; font-size: 1.1em;">‚ö†Ô∏è Setup Required</p>
                             <p style="font-size: 0.9em; margin-bottom: 8px; color: #ccc;">
                                To connect your phone, this page must be hosted on a network server (not just a file).
                             </p>
                             <div style="text-align:left; margin-bottom:10px; font-size:0.85em; background:rgba(255,255,255,0.1); padding:8px; border-radius:4px;">
                                <strong>1. Start a server</strong> (e.g. Python: <code>python -m http.server</code>)<br>
                                <strong>2. Enter your Computer's LAN IP:</strong>
                             </div>
                             <input type="text" id="lan-ip-input" placeholder="192.168.1.x:8000" style="padding: 8px; width: 90%; border-radius: 4px; border: 1px solid #555; background: #222; color: white; text-align:center;">
                             <button onclick="window.System.generateQRCode(document.getElementById('lan-ip-input').value)" style="margin-top: 12px; padding: 8px 20px; background: var(--accent); color: black; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; display:block; margin-left:auto; margin-right:auto;">Generate QR</button>
                         </div>
                     `;
                     return;
                }

                // Construct Base URL - Force HTTP if file protocol was used originally
                let finalProtocol = protocol;
                if (protocol === 'file:') finalProtocol = 'http:';
                
                let finalBaseUrl;
                if (manualIp) {
                    // If user didn't specify protocol in input, add it
                    if (manualIp.startsWith('http')) {
                         finalBaseUrl = manualIp + window.location.pathname;
                    } else {
                         // If user entered IP:PORT, usage
                         finalBaseUrl = `${finalProtocol}//${manualIp}${window.location.pathname}`;
                    }
                } else {
                    finalBaseUrl = window.location.href.split('?')[0];
                }

                qrContainer.innerHTML = '<div style="padding: 20px; text-align: center;">Initializing Secure Session...</div>';

                if (!window.BridgeClient) {
                     qrContainer.innerHTML = '<div style="color:#c00;padding:20px;">Error: BridgeClient library missing.</div>';
                     return;
                }

                // Initialize P2P Client
                if (!this._p2pBridgeClient) {
                    this._p2pBridgeClient = new BridgeClient();
                    
                    // Hook up Desktop Icon creation
                    this._p2pBridgeClient.onFileReceived = (blob, name) => {
                        console.log('File Received!', name);
                        this.createDesktopIcon(blob, name);
                        document.getElementById('qr-instructions').textContent = 'File received! Ready for more.';
                        
                        // Play a sound? 
                        // const audio = new Audio('ding.mp3'); audio.play().catch(e=>{});
                    };

                    // Progress indicator
                    this._p2pBridgeClient.onProgress = (current, total) => {
                         const percent = Math.round((current / total) * 100);
                         document.getElementById('qr-instructions').textContent = `Receiving: ${percent}%`;
                    };

                    this._p2pBridgeClient.onStatusChange = (status) => {
                        console.log('P2P Status:', status);
                        if (status.includes('Connected')) {
                            document.getElementById('qr-title').textContent = 'Connected!';
                            document.getElementById('qr-instructions').textContent = 'Ready to drop files...';
                            document.getElementById('qr-code').style.opacity = '0.2';
                        }
                    };
                }
                
                // Start polling first so we don't miss any early answers (unlikely but safe)
                this.pollSignals(sessionId, 0, (signals) => {
                    signals.forEach(async (s) => {
                        // We are Initiator, so we look for 'remote' answers/ice
                        if (s.sender === 'remote') {
                            if (s.type === 'answer') {
                                console.log('‚úÖ Received Answer via Signal Server');
                                document.getElementById('qr-title').textContent = 'Connected!';
                                document.getElementById('qr-instructions').textContent = 'Ready to receive files.';
                                document.getElementById('qr-code').style.opacity = '0.2'; // Dim QR
                                await this._p2pBridgeClient.acceptAnswer(s.content);
                            } else if (s.type === 'ice') {
                                await this._p2pBridgeClient.addIceCandidate(s.content);
                            }
                        }
                    });
                });

                // Start WebRTC and push Offer to server
                await this._p2pBridgeClient.startAsInitiator(async (signal) => {
                     // Signal callback: send to server
                     // signal is { type: 'offer', sdp: ... } or { type: 'ice', candidate: ... }
                     await this.sendSignal(sessionId, {
                         type: signal.type,
                         sender: 'initiator',
                         content: signal.sdp || signal.candidate // Normalize content
                     });
                });

                // Generate QR Code with Session ID
                qrContainer.innerHTML = '';
                const targetUrl = `${finalBaseUrl}?mobile=1&session=${sessionId}`;
                
                console.log('Generating QR with target:', targetUrl);

                new QRCode(qrContainer, {
                    text: targetUrl,
                    width: 300,
                    height: 300,
                    correctLevel: QRCode.CorrectLevel.L
                });
            }

            toggleQRCode() {
                const container = document.getElementById('qr-container');
                const toggle = document.getElementById('qr-toggle');

                console.log('toggleQRCode called. Container:', container, 'Has show class:', container.classList.contains('show'));

                if (container.classList.contains('show')) {
                    container.classList.remove('show');
                    toggle.textContent = 'üì± Mobile';
                    console.log('QR hidden');
                } else {
                    console.log('Generating QR code...');
                    this.generateQRCode();
                    container.classList.add('show');
                    toggle.textContent = '‚úï Close';
                    console.log('QR shown');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.System = new VirtualSystem();
        });

        // Global functions for HTML onclick handlers
        function toggleStartMenu() {
            if (window.System) window.System.toggleStartMenu();
        }

        function toggleTooltips() {
            if (window.System) window.System.toggleTooltips();
        }

        function restoreWindow(id) {
            if (window.System) window.System.restoreWindow(id);
        }

        function maximizeWindow(id) {
            if (window.System) window.System.maximizeWindow(id);
        }

        function minimizeWindow(id) {
            if (window.System) window.System.minimizeWindow(id);
        }

        function closeWindow(id) {
            if (window.System) window.System.closeWindow(id);
        }

        function splitWindowLeft(id) {
            if (window.System) window.System.splitWindowLeft(id);
        }

        function splitWindowRight(id) {
            if (window.System) window.System.splitWindowRight(id);
        }

        function toggleQRCode() {
            if (window.System) window.System.toggleQRCode();
        }
    </script>
</body>

</html>